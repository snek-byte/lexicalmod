/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';var h=require("@lexical/react/LexicalComposerContext"),v=require("lexical"),x=require("react"),y=require("@lexical/utils"),z="undefined"!==typeof window&&"undefined"!==typeof window.document&&"undefined"!==typeof window.document.createElement?x.useLayoutEffect:x.useEffect;class A{constructor(c){this.key=c;this.ref={current:null};this.setRefElement=this.setRefElement.bind(this)}setRefElement(c){this.ref={current:c}}}
let B=c=>{const a=document.getElementById("typeahead-menu");if(a){var d=a.getBoundingClientRect();d.top+d.height>window.innerHeight&&a.scrollIntoView({block:"center"});0>d.top&&a.scrollIntoView({block:"center"});c.scrollIntoView({block:"nearest"})}};
function C(c){var a=v.$getSelection();if(!v.$isRangeSelection(a)||!a.isCollapsed())return null;var d=a.anchor;if("text"!==d.type)return null;a=d.getNode();if(!a.isSimpleText())return null;d=d.offset;let l=a.getTextContent().slice(0,d);var f=c.matchingString;c=c.replaceableString.length;for(let r=c;r<=f.length;r++)l.substr(-r)===f.substr(0,r)&&(c=r);c=d-c;if(0>c)return null;let n;0===c?[n]=a.splitText(d):[,n]=a.splitText(c,d);return n}
function D(c,a){let d=getComputedStyle(c),l="absolute"===d.position;a=a?/(auto|scroll|hidden)/:/(auto|scroll)/;if("fixed"===d.position)return document.body;for(;c=c.parentElement;)if(d=getComputedStyle(c),(!l||"static"!==d.position)&&a.test(d.overflow+d.overflowY+d.overflowX))return c;return document.body}function E(c,a){c=c.getBoundingClientRect();a=a.getBoundingClientRect();return c.top>a.top&&c.top<a.bottom}
function F(c,a,d,l){let [f]=h.useLexicalComposerContext();x.useEffect(()=>{if(null!=a&&null!=c){let n=f.getRootElement(),r=null!=n?D(n,!1):document.body,w=!1,g=E(a,r),b=function(){w||(window.requestAnimationFrame(function(){d();w=!1}),w=!0);const q=E(a,r);q!==g&&(g=q,null!=l&&l(q))},p=new ResizeObserver(d);window.addEventListener("resize",d);document.addEventListener("scroll",b,{capture:!0,passive:!0});p.observe(a);return()=>{p.unobserve(a);window.removeEventListener("resize",d);document.removeEventListener("scroll",
b,!0)}}},[a,f,l,d,c])}let G=v.createCommand("SCROLL_TYPEAHEAD_OPTION_INTO_VIEW_COMMAND");
function H({close:c,editor:a,anchorElementRef:d,resolution:l,options:f,menuRenderFn:n,onSelectOption:r,shouldSplitNodeWithQuery:w=!1,commandPriority:g=v.COMMAND_PRIORITY_LOW}){let [b,p]=x.useState(null);x.useEffect(()=>{p(0)},[l.match&&l.match.matchingString]);let q=x.useCallback(e=>{a.update(()=>{const m=null!=l.match&&w?C(l.match):null;r(e,m,c,l.match?l.match.matchingString:"")})},[a,w,l.match,r,c]),t=x.useCallback(e=>{const m=a.getRootElement();null!==m&&(m.setAttribute("aria-activedescendant",
"typeahead-item-"+e),p(e))},[a]);x.useEffect(()=>()=>{let e=a.getRootElement();null!==e&&e.removeAttribute("aria-activedescendant")},[a]);z(()=>{null===f?p(null):null===b&&t(0)},[f,b,t]);x.useEffect(()=>y.mergeRegister(a.registerCommand(G,({option:e})=>e.ref&&null!=e.ref.current?(B(e.ref.current),!0):!1,g)),[a,t,g]);x.useEffect(()=>y.mergeRegister(a.registerCommand(v.KEY_ARROW_DOWN_COMMAND,e=>{if(null!==f&&f.length&&null!==b){let m=b!==f.length-1?b+1:0;t(m);let k=f[m];null!=k.ref&&k.ref.current&&
a.dispatchCommand(G,{index:m,option:k});e.preventDefault();e.stopImmediatePropagation()}return!0},g),a.registerCommand(v.KEY_ARROW_UP_COMMAND,e=>{if(null!==f&&f.length&&null!==b){var m=0!==b?b-1:f.length-1;t(m);m=f[m];null!=m.ref&&m.ref.current&&B(m.ref.current);e.preventDefault();e.stopImmediatePropagation()}return!0},g),a.registerCommand(v.KEY_ESCAPE_COMMAND,e=>{e.preventDefault();e.stopImmediatePropagation();c();return!0},g),a.registerCommand(v.KEY_TAB_COMMAND,e=>{if(null===f||null===b||null==
f[b])return!1;e.preventDefault();e.stopImmediatePropagation();q(f[b]);return!0},g),a.registerCommand(v.KEY_ENTER_COMMAND,e=>{if(null===f||null===b||null==f[b])return!1;null!==e&&(e.preventDefault(),e.stopImmediatePropagation());q(f[b]);return!0},g)),[q,c,a,f,b,t,g]);let u=x.useMemo(()=>({options:f,selectOptionAndCleanUp:q,selectedIndex:b,setHighlightedIndex:p}),[q,b,f]);return n(d,u,l.match?l.match.matchingString:"")}
function I(c,a,d,l=document.body){let [f]=h.useLexicalComposerContext(),n=x.useRef(document.createElement("div")),r=x.useCallback(()=>{n.current.style.top=n.current.style.bottom;const g=f.getRootElement(),b=n.current;var p=b.firstChild;if(null!==g&&null!==c){const {left:t,top:u,width:e,height:m}=c.getRect();b.style.top=`${u+window.pageYOffset+n.current.offsetHeight+3}px`;b.style.left=`${t+window.pageXOffset}px`;b.style.height=`${m}px`;b.style.width=`${e}px`;if(null!==p){p.style.top=`${u}`;var q=p.getBoundingClientRect();
p=q.height;q=q.width;const k=g.getBoundingClientRect();t+q>k.right&&(b.style.left=`${k.right-q+window.pageXOffset}px`);(u+p>window.innerHeight||u+p>k.bottom)&&u-k.top>p&&(b.style.top=`${u-p+window.pageYOffset-m}px`)}b.isConnected||(null!=d&&(b.className=d),b.setAttribute("aria-label","Typeahead menu"),b.setAttribute("id","typeahead-menu"),b.setAttribute("role","listbox"),b.style.display="block",b.style.position="absolute",l.append(b));n.current=b;g.setAttribute("aria-controls","typeahead-menu")}},
[f,c,d,l]);x.useEffect(()=>{let g=f.getRootElement();if(null!==c)return r(),()=>{null!==g&&g.removeAttribute("aria-controls");let b=n.current;null!==b&&b.isConnected&&b.remove()}},[f,r,c]);let w=x.useCallback(g=>{null!==c&&(g||a(null))},[c,a]);F(c,n.current,r,w);return n}
exports.LexicalContextMenuPlugin=function({options:c,onClose:a,onOpen:d,onSelectOption:l,menuRenderFn:f,anchorClassName:n,commandPriority:r=v.COMMAND_PRIORITY_LOW,parent:w}){let [g]=h.useLexicalComposerContext(),[b,p]=x.useState(null),q=x.useRef(null);n=I(b,p,n,w);let t=x.useCallback(()=>{p(null);null!=a&&null!==b&&a()},[a,b]),u=x.useCallback(k=>{p(k);null!=d&&null===b&&d(k)},[d,b]),e=x.useCallback(k=>{k.preventDefault();u({getRect:()=>new DOMRect(k.clientX,k.clientY,1,1)})},[u]),m=x.useCallback(k=>
{null===b||null==q.current||null==k.target||q.current.contains(k.target)||t()},[t,b]);x.useEffect(()=>{let k=g.getRootElement();if(k)return k.addEventListener("contextmenu",e),()=>k.removeEventListener("contextmenu",e)},[g,e]);x.useEffect(()=>{document.addEventListener("click",m);return()=>document.removeEventListener("click",m)},[g,m]);return null===b||null===g?null:x.createElement(H,{close:t,resolution:b,editor:g,anchorElementRef:n,options:c,menuRenderFn:(k,J)=>f(k,J,{setMenuRef:K=>{q.current=K}}),
onSelectOption:l,commandPriority:r})};exports.MenuOption=A
